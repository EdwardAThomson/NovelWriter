# NovelWriter Workflow File Analysis & Fix

## Problem Summary
The workflow progress checker is not matching files correctly because there are inconsistencies between where files are actually saved and where the checkpoint system expects them.

## Current File Organization Analysis

### 1. Lore Step Files ✅ CORRECT
**Expected Pattern**: `story/lore/*.md`, `story/lore/*.json`
**Actual Location**: `current_work/story/lore/`
**Files Generated**:
- `characters.json` - Character data
- `factions.json` - Faction data  
- `generated_lore.md` - Main lore content
- `background_*.md` - Character backstories

**Status**: ✅ Patterns match correctly

### 2. Structure Step Files ⚠️ NEEDS REVIEW
**Expected Pattern**: `story/structure/*.md`
**Actual Location**: `current_work/story/structure/`
**Files Generated**:
- `6-act_structure_*.md` - One file per story section
- `character_arcs.md` - Character development arcs
- `faction_arcs.md` - Faction storylines
- `reconciled_arcs.md` - Combined character/faction arcs
- `reconciled_locations_arcs.md` - Arcs with location details

**Issues**:
- Some arc files are duplicated in planning directory
- Need to clarify which step owns which files

### 3. Scenes Step Files ⚠️ NEEDS REVIEW  
**Expected Pattern**: `story/planning/*.md`
**Actual Location**: `current_work/story/planning/`
**Files Generated**:
- `scenes_*.md` - Scene planning files
- `character_arcs.md` - ❌ DUPLICATE from structure step
- `faction_arcs.md` - ❌ DUPLICATE from structure step
- `reconciled_arcs.md` - ❌ DUPLICATE from structure step
- `reconciled_locations_arcs.md` - ❌ DUPLICATE from structure step
- `suggested_titles.md` - Title suggestions

**Issues**:
- Arc files are being saved to both structure and planning directories
- Creates confusion about which step completed which files

### 4. Chapters Step Files ❌ PROBLEM
**Expected Pattern**: `story/content/*.md`, `story/content/**/*.md`
**Actual Location**: `current_work/story/content/` (currently empty)
**Files Should Generate**:
- `chapters/chapter_*.md` - Individual chapter files
- `prose_short_story_*.md` - For short stories

**Issues**:
- Chapter writing may not be saving to structured directory
- Need to verify chapter writing agent uses correct paths

## Root Causes

### 1. File Duplication
Arc files are being generated by structure step but also copied/regenerated by scenes step, causing confusion about step ownership.

### 2. Legacy Path Usage
Some components may still be using old flat directory structure instead of new `story/` subdirectories.

### 3. Chapter Writing Path Issues
Chapter writing system may not be integrated with the structured directory system.

## Recommended Solutions

### Phase 1: Clarify File Ownership
1. **Structure Step** should own:
   - `story/structure/6-act_structure_*.md`
   - `story/structure/character_arcs.md`
   - `story/structure/faction_arcs.md`
   - `story/structure/reconciled_arcs.md`

2. **Scenes Step** should own:
   - `story/planning/scenes_*.md`
   - `story/planning/reconciled_locations_arcs.md` (final version with locations)
   - `story/planning/suggested_titles.md`

3. **Chapters Step** should own:
   - `story/content/chapters/chapter_*.md`
   - `story/content/prose_short_story_*.md`

### Phase 2: Update File Patterns
Update checkpoint system expected files to match actual ownership:

```python
self.expected_files = {
    "lore": [
        "story/lore/characters.json",
        "story/lore/factions.json", 
        "story/lore/generated_lore.md",
        "story/lore/background_*.md"
    ],
    "structure": [
        "story/structure/6-act_structure_*.md",
        "story/structure/character_arcs.md",
        "story/structure/faction_arcs.md", 
        "story/structure/reconciled_arcs.md"
    ],
    "scenes": [
        "story/planning/scenes_*.md",
        "story/planning/reconciled_locations_arcs.md",
        "story/planning/suggested_titles.md"
    ],
    "chapters": [
        "story/content/chapters/chapter_*.md",
        "story/content/prose_short_story_*.md"
    ]
}
```

### Phase 3: Verify Chapter Writing Integration
Ensure chapter writing components save to structured directories:
- Check `ChapterWritingAgent` output paths
- Verify GUI chapter writing uses `story/content/` directory
- Update any legacy path references

### Phase 4: Clean Up Duplicates
Remove duplicate file generation:
- Structure step generates initial arcs
- Scenes step enhances arcs with locations (saves as new file)
- Avoid regenerating the same content in multiple steps

## Implementation Priority
1. **High**: Update checkpoint file patterns to match current reality
2. **High**: Verify chapter writing uses structured directories  
3. **Medium**: Clean up duplicate file generation
4. **Low**: Migrate any remaining legacy flat directory usage

## Testing Plan
1. Run complete workflow and verify all files are detected correctly
2. Test progress display shows accurate step completion
3. Verify file counts match expected patterns
4. Test both novel and short story workflows

## Files to Modify
1. `agents/orchestration/checkpoint_state.py` - Update expected file patterns
2. `agents/writing/chapter_writing_agent.py` - Verify output paths
3. `core/gui/chapter_writing.py` - Check GUI integration
4. Any remaining components using legacy paths
